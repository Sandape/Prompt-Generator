{% extends "base.html" %}

{% block title %}é¡¹ç›®é€‰æ‹© - Prompt Generator{% endblock %}

{% block content %}
<h1>é¡¹ç›®ç©ºé—´ç®¡ç†</h1>

<div class="projects-container">
    <div class="projects-header">
        <h2>æˆ‘çš„é¡¹ç›®ç©ºé—´</h2>
        {% if can_create %}
        <a href="/projects/create" class="btn btn-primary">æ–°å»ºé¡¹ç›®ç©ºé—´</a>
        {% else %}
        <button type="button" class="btn btn-primary" onclick="showProjectLimitModal()">æ–°å»ºé¡¹ç›®ç©ºé—´</button>
        {% endif %}
    </div>

    {% if projects %}
    <div class="projects-list">
        {% for project in projects %}
        <div class="project-bar" onclick="window.location.href='/projects/{{ project.id }}/tasks'">
            <div class="project-bar-main">
                <span class="project-bar-name">{{ project.name }}</span>
                <button type="button" class="btn-edit-project" onclick="event.stopPropagation(); openEditModal({{ project.id }}, '{{ project.name }}')" title="ç¼–è¾‘é¡¹ç›®">
                    âœï¸
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="no-projects">
        <div class="no-projects-icon">ğŸ“</div>
        <h3>æš‚æ— é¡¹ç›®ç©ºé—´</h3>
        <p>åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªé¡¹ç›®ç©ºé—´æ¥å¼€å§‹ä½¿ç”¨Prompt Generator</p>
    </div>
    {% endif %}
</div>

<div style="text-align: center; margin-top: 3rem;">
    <a href="/menu" class="btn btn-secondary">è¿”å›èœå•</a>
</div>

<!-- é¡¹ç›®æ•°é‡é™åˆ¶å¼¹çª— -->
<div id="projectLimitModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>é¡¹ç›®æ•°é‡é™åˆ¶</h3>
            <span class="modal-close" onclick="closeProjectLimitModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="modal-icon">âš ï¸</div>
            <p class="modal-message">æ‚¨å·²ç»è¾¾åˆ°äº†é¡¹ç›®ç©ºé—´æ•°é‡ä¸Šé™ï¼ˆ{{ max_projects }}ä¸ªï¼‰ã€‚</p>
            <p class="modal-description">è¦åˆ›å»ºæ–°é¡¹ç›®ç©ºé—´ï¼Œè¯·é€‰æ‹©ä¸€ä¸ªé¡¹ç›®ç©ºé—´è¿›è¡Œåˆ é™¤ï¼š</p>

            <div class="modal-projects-list">
                {% for project in projects %}
                <div class="modal-project-bar" data-project-id="{{ project.id }}" onclick="selectProjectForDeletion({{ project.id }}, '{{ project.name }}')">
                    <div class="modal-project-bar-main">
                        <span class="modal-project-bar-name">{{ project.name }}</span>
                        <span class="modal-project-bar-date">{{ project.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                    </div>
                    <!-- åˆ é™¤çŠ¶æ€æç¤ºä¼šé€šè¿‡ä¼ªå…ƒç´ æ˜¾ç¤º -->
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeProjectLimitModal()">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<!-- é¡¹ç›®ç¼–è¾‘å¼¹çª— -->
<div id="editProjectModal" class="modal">
    <div class="modal-content edit-modal-content">
        <div class="modal-header">
            <h3>ç¼–è¾‘é¡¹ç›®ç©ºé—´</h3>
            <span class="modal-close" onclick="closeEditModal()">&times;</span>
        </div>
        <form id="editProjectForm" class="modal-body" method="post">
            <div class="form-group">
                <label for="edit_project_name">é¡¹ç›®ç©ºé—´åç§° *</label>
                <input type="text" id="edit_project_name" name="name" required
                       placeholder="è¯·è¾“å…¥é¡¹ç›®ç©ºé—´åç§°"
                       class="form-input-valid">
            </div>

            <div class="form-group">
                <label for="edit_development_standard">é¡¹ç›®å¼€å‘è§„èŒƒ</label>
                <div class="standards-container">
                    <div class="standards-display">
                        <div class="standards-ball" id="editStandardsBall">
                            <span class="standards-count" id="editStandardsCount">0</span>
                        </div>
                        <span class="standards-label">å·²æ·»åŠ è§„èŒƒ</span>
                    </div>
                    <div class="standards-panel" id="editStandardsPanel">
                        <div class="standards-header">
                            <h4>é¡¹ç›®å¼€å‘è§„èŒƒ</h4>
                            <button type="button" class="btn-close" id="editCloseStandards">&times;</button>
                        </div>
                        <div class="standards-list" id="editStandardsList">
                            <!-- åŠ¨æ€ç”Ÿæˆçš„è§„èŒƒåˆ—è¡¨ -->
                        </div>
                        <div class="standards-actions">
                            <button type="button" class="btn btn-secondary btn-small" id="editAddStandard">æ–°å¢è§„èŒƒ</button>
                        </div>
                    </div>
                    <!-- éšè—å­—æ®µå­˜å‚¨è§„èŒƒæ•°æ® -->
                    <input type="hidden" id="edit_development_standard" name="development_standard">
                </div>
            </div>

            <div class="form-group">
                <label for="edit_interface_example">é¡¹ç›®å±‚çº§ç¤ºä¾‹æ¥å£è·¯å¾„</label>
                <input type="text" id="edit_interface_example" name="interface_example" required
                       placeholder="è¯·è¾“å…¥é¡¹ç›®å±‚çº§ç¤ºä¾‹æ¥å£è·¯å¾„"
                       class="form-input-valid">
            </div>

            <div class="form-group">
                <label for="edit_entity_example">ç¤ºä¾‹å®ä½“ç±»æ¥å£è·¯å¾„</label>
                <input type="text" id="edit_entity_example" name="entity_example" required
                       placeholder="è¯·è¾“å…¥ç¤ºä¾‹å®ä½“ç±»æ¥å£è·¯å¾„"
                       class="form-input-valid">
            </div>

            <div class="form-group">
                <label for="edit_mapper_example">ç¤ºä¾‹Mapperç±»æ¥å£è·¯å¾„</label>
                <input type="text" id="edit_mapper_example" name="mapper_example" required
                       placeholder="è¯·è¾“å…¥ç¤ºä¾‹Mapperç±»æ¥å£è·¯å¾„"
                       class="form-input-valid">
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // é¡¹ç›®ç©ºé—´ç®¡ç†ç›¸å…³å‡½æ•°
    function showProjectLimitModal() {
        const modal = document.getElementById('projectLimitModal');
        modal.classList.add('show');
        document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
    }

    function closeProjectLimitModal() {
        const modal = document.getElementById('projectLimitModal');

        // æ·»åŠ å…³é—­åŠ¨ç”»
        modal.classList.add('closing');
        modal.classList.remove('show');

        // ç­‰å¾…åŠ¨ç”»å®Œæˆåéšè—æ¨¡æ€æ¡†
        setTimeout(() => {
            modal.classList.remove('closing');
            document.body.style.overflow = ''; // æ¢å¤èƒŒæ™¯æ»šåŠ¨

            // é‡ç½®æ‰€æœ‰é¡¹ç›®çŠ¶æ€
            document.querySelectorAll('.modal-project-bar').forEach(bar => {
                bar.classList.remove('selected', 'confirm-delete');
            });

            // é‡ç½®é€‰ä¸­çŠ¶æ€
            selectedProjectForDeletion = null;
        }, 300); // åŠ¨ç”»æŒç»­æ—¶é—´
    }

    // å­˜å‚¨é€‰ä¸­çš„é¡¹ç›®ä¿¡æ¯
    let selectedProjectForDeletion = null;

    function selectProjectForDeletion(projectId, projectName) {
        const projectBar = document.querySelector(`[data-project-id="${projectId}"]`);

        // å¦‚æœç‚¹å‡»çš„æ˜¯å·²ç»é€‰ä¸­çš„é¡¹ç›®ï¼Œè¿›è¡Œç¡®è®¤åˆ é™¤
        if (projectBar.classList.contains('selected')) {
            confirmDeleteProject(projectId, projectName);
            return;
        }

        // é‡ç½®å…¶ä»–é¡¹ç›®çŠ¶æ€
        document.querySelectorAll('.modal-project-bar').forEach(bar => {
            bar.classList.remove('selected', 'confirm-delete');
        });

        // é€‰ä¸­å½“å‰é¡¹ç›®
        projectBar.classList.add('selected');

        selectedProjectForDeletion = { id: projectId, name: projectName };

        // 3ç§’åè‡ªåŠ¨å–æ¶ˆé€‰æ‹©
        setTimeout(() => {
            if (selectedProjectForDeletion && selectedProjectForDeletion.id === projectId) {
                projectBar.classList.remove('selected');
                selectedProjectForDeletion = null;
            }
        }, 3000);
    }

    function confirmDeleteProject(projectId, projectName) {
        const projectBar = document.querySelector(`[data-project-id="${projectId}"]`);

        // æ·»åŠ ç¡®è®¤åˆ é™¤çŠ¶æ€
        projectBar.classList.add('confirm-delete');

        // å‘é€åˆ é™¤è¯·æ±‚
        fetch(`/projects/${projectId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (response.ok) {
                // åˆ é™¤æˆåŠŸï¼Œå…³é—­å¼¹çª—å¹¶ç«‹å³åˆ·æ–°é¡µé¢
                closeProjectLimitModal();
                window.location.reload();
            } else {
                throw new Error('åˆ é™¤å¤±è´¥');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('åˆ é™¤é¡¹ç›®ç©ºé—´å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');

            // é‡ç½®çŠ¶æ€
            projectBar.classList.remove('selected', 'confirm-delete');
            selectedProjectForDeletion = null;
        });
    }

    function showMessage(message, type = 'info') {
        const existingMessage = document.querySelector('.message');
        if (existingMessage) {
            existingMessage.remove();
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}-message`;
        messageDiv.textContent = message;

        const container = document.querySelector('.container');
        container.insertBefore(messageDiv, container.firstChild);

        setTimeout(() => {
            messageDiv.remove();
        }, 5000);
    }

    // é¡µé¢åŠ è½½åçš„åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // é¡¹ç›®ç©ºé—´æ¨ªæ¡äº¤äº’æ•ˆæœ
        const projectBars = document.querySelectorAll('.project-bar');
        projectBars.forEach(bar => {
            bar.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-1px)';
            });
            bar.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­å¼¹çª—
        const modal = document.getElementById('projectLimitModal');
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeProjectLimitModal();
                }
            });
        }

        // ç¼–è¾‘æ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»å…³é—­
        const editModal = document.getElementById('editProjectModal');
        if (editModal) {
            editModal.addEventListener('click', function(e) {
                if (e.target === editModal) {
                    closeEditModal();
                }
            });
        }

        // ESCé”®å…³é—­å¼¹çª—
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeProjectLimitModal();
                closeEditModal();
            }
        });
    });

    // é¡¹ç›®ç¼–è¾‘ç›¸å…³å‡½æ•°
    let currentEditingProjectId = null;

    function openEditModal(projectId, projectName) {
        currentEditingProjectId = projectId;

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        showMessage('æ­£åœ¨åŠ è½½é¡¹ç›®ä¿¡æ¯...', 'info');

        // è·å–é¡¹ç›®è¯¦ç»†ä¿¡æ¯
        fetch(`/projects/${projectId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('è·å–é¡¹ç›®ä¿¡æ¯å¤±è´¥');
                }
                return response.json();
            })
            .then(project => {
                // å¡«å……è¡¨å•æ•°æ®
                document.getElementById('edit_project_name').value = project.name;
                document.getElementById('edit_interface_example').value = project.interface_example || '';
                document.getElementById('edit_entity_example').value = project.entity_example || '';
                document.getElementById('edit_mapper_example').value = project.mapper_example || '';

                // å¤„ç†å¼€å‘è§„èŒƒ
                loadEditStandards(project.development_standard || '');

                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                const modal = document.getElementById('editProjectModal');
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';

                // æ¸…é™¤ä¹‹å‰çš„æ¶ˆæ¯
                setTimeout(() => {
                    const existingMessage = document.querySelector('.message');
                    if (existingMessage) {
                        existingMessage.remove();
                    }
                }, 1000);
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('åŠ è½½é¡¹ç›®ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            });
    }

    function closeEditModal() {
        const modal = document.getElementById('editProjectModal');

        // æ·»åŠ å…³é—­åŠ¨ç”»
        modal.classList.add('closing');
        modal.classList.remove('show');

        // ç­‰å¾…åŠ¨ç”»å®Œæˆåéšè—æ¨¡æ€æ¡†
        setTimeout(() => {
            modal.classList.remove('closing');
            document.body.style.overflow = ''; // æ¢å¤èƒŒæ™¯æ»šåŠ¨
            currentEditingProjectId = null;

            // é‡ç½®è¡¨å•
            document.getElementById('editProjectForm').reset();
            document.getElementById('editStandardsList').innerHTML = '';
            document.getElementById('editStandardsCount').textContent = '0';
        }, 300);
    }

    function loadEditStandards(standardsValue) {
        let standards = [];

        // ä»éšè—å­—æ®µåŠ è½½ç°æœ‰è§„èŒƒ
        if (standardsValue) {
            // å¦‚æœæ˜¯æ— åºåˆ—è¡¨æ ¼å¼ï¼Œè§£æä¸ºæ•°ç»„
            if (standardsValue.includes('- ')) {
                standards = standardsValue.split('\n')
                    .filter(line => line.trim().startsWith('- '))
                    .map(line => line.trim().substring(2));
            } else {
                // å¦‚æœæ˜¯æ—§æ ¼å¼ï¼ŒæŒ‰è¡Œåˆ†å‰²
                standards = standardsValue.split('\n').filter(line => line.trim());
            }
        }

        // æ›´æ–°éšè—å­—æ®µå’Œæ˜¾ç¤º
        updateEditStandardsDisplay(standards);
        renderEditStandardsList(standards);
    }

    function updateEditStandardsDisplay(standards) {
        const count = standards.filter(s => s.trim()).length;
        document.getElementById('editStandardsCount').textContent = count;
    }

    function renderEditStandardsList(standards) {
        const standardsList = document.getElementById('editStandardsList');
        standardsList.innerHTML = '';

        standards.forEach((standard, index) => {
            const standardItem = document.createElement('div');
            standardItem.className = 'standard-item';
            standardItem.innerHTML = `
                <input type="text" class="standard-input" value="${standard}" data-index="${index}">
                <button type="button" class="btn-delete" data-index="${index}">åˆ é™¤</button>
            `;
            standardsList.appendChild(standardItem);
        });

        // ç»‘å®šäº‹ä»¶
        document.querySelectorAll('#editStandardsList .standard-input').forEach(input => {
            input.addEventListener('input', function() {
                const index = parseInt(this.dataset.index);
                standards[index] = this.value;
                updateEditHiddenField(standards);
                updateEditStandardsDisplay(standards);
            });
        });

        document.querySelectorAll('#editStandardsList .btn-delete').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                standards.splice(index, 1);
                updateEditStandardsDisplay(standards);
                renderEditStandardsList(standards);
                updateEditHiddenField(standards);
            });
        });
    }

    function updateEditHiddenField(standards) {
        const validStandards = standards.filter(standard => standard.trim());
        const formattedStandards = validStandards.length > 0
            ? validStandards.map(standard => `- ${standard.trim()}`).join('\n')
            : "";
        document.getElementById('edit_development_standard').value = formattedStandards;
    }

    // ç¼–è¾‘æ¨¡æ€æ¡†çš„å¼€å‘è§„èŒƒç®¡ç†
    document.addEventListener('DOMContentLoaded', function() {
        const editStandardsBall = document.getElementById('editStandardsBall');
        const editStandardsPanel = document.getElementById('editStandardsPanel');
        const editAddStandardBtn = document.getElementById('editAddStandard');
        const editCloseStandardsBtn = document.getElementById('editCloseStandards');

        // åœ†çƒç‚¹å‡»äº‹ä»¶
        editStandardsBall.addEventListener('click', function() {
            editStandardsPanel.style.display = editStandardsPanel.style.display === 'block' ? 'none' : 'block';
        });

        // å…³é—­æŒ‰é’®
        editCloseStandardsBtn.addEventListener('click', function() {
            editStandardsPanel.style.display = 'none';
        });

        // æ–°å¢è§„èŒƒ
        editAddStandardBtn.addEventListener('click', function() {
            const standardsList = document.getElementById('editStandardsList');
            const newIndex = standardsList.children.length;

            const standardItem = document.createElement('div');
            standardItem.className = 'standard-item';
            standardItem.innerHTML = `
                <input type="text" class="standard-input" value="" data-index="${newIndex}" placeholder="è¯·è¾“å…¥è§„èŒƒå†…å®¹">
                <button type="button" class="btn-delete" data-index="${newIndex}">åˆ é™¤</button>
            `;

            standardsList.appendChild(standardItem);

            // ç»‘å®šæ–°å…ƒç´ çš„äº‹ä»¶
            const newInput = standardItem.querySelector('.standard-input');
            const newDeleteBtn = standardItem.querySelector('.btn-delete');

            newInput.addEventListener('input', function() {
                updateEditHiddenField(getCurrentEditStandards());
                updateEditStandardsDisplay(getCurrentEditStandards());
            });

            newDeleteBtn.addEventListener('click', function() {
                standardItem.remove();
                updateEditHiddenField(getCurrentEditStandards());
                updateEditStandardsDisplay(getCurrentEditStandards());
            });

            // èšç„¦åˆ°æ–°è¾“å…¥æ¡†
            setTimeout(() => {
                newInput.focus();
            }, 100);
        });

        // ç‚¹å‡»é¢æ¿å¤–éƒ¨å…³é—­
        document.addEventListener('click', function(e) {
            if (!editStandardsBall.contains(e.target) && !editStandardsPanel.contains(e.target)) {
                editStandardsPanel.style.display = 'none';
            }
        });

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('editProjectForm').addEventListener('submit', function(e) {
            e.preventDefault();

            if (!currentEditingProjectId) {
                showMessage('é¡¹ç›®IDä¸¢å¤±ï¼Œè¯·é‡æ–°æ“ä½œ', 'error');
                return;
            }

            const formData = new FormData(this);

            // æ˜¾ç¤ºæäº¤çŠ¶æ€
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'ä¿å­˜ä¸­...';
            submitBtn.disabled = true;

            fetch(`/projects/${currentEditingProjectId}/edit`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    showMessage('é¡¹ç›®ä¿¡æ¯æ›´æ–°æˆåŠŸï¼', 'success');
                    closeEditModal();
                    // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ›´æ–°åçš„ä¿¡æ¯
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    throw new Error('æ›´æ–°å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('æ›´æ–°é¡¹ç›®ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            })
            .finally(() => {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        });
    });

    function getCurrentEditStandards() {
        const inputs = document.querySelectorAll('#editStandardsList .standard-input');
        return Array.from(inputs).map(input => input.value);
    }
</script>
{% endblock %}
